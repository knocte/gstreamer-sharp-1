From 15380be815ec0719c656614f63de3ff571a17c5c Mon Sep 17 00:00:00 2001
From: Stephan Sundermann <stephansundermann@gmail.com>
Date: Mon, 17 Mar 2014 00:14:48 +0100
Subject: [PATCH] generator: update to latest generator

---
 .gitignore                       |  2 +-
 configure.ac                     |  4 ++--
 gstreamer-sharp.csproj           |  2 +-
 sources/Makefile.am              |  9 ++++++---
 sources/glue/Makefile.am         |  2 +-
 sources/gstreamer-sharp.metadata | 26 --------------------------
 6 files changed, 11 insertions(+), 34 deletions(-)

diff --git a/.gitignore b/.gitignore
index cef9d37..eadac0c 100644
--- a/.gitignore
+++ b/.gitignore
@@ -23,7 +23,7 @@ sources/glue/*.la
 sources/glue/.libs/
 
 # generated by the generator (we don't want anyone to commit these to the repo)
-sources/generated/*.cs
+sources/generated/*/*.cs
 sources/glue/generated.c
 doc/*
 sources/generated-stamp
diff --git a/configure.ac b/configure.ac
index 798b4c4..546b116 100644
--- a/configure.ac
+++ b/configure.ac
@@ -73,14 +73,14 @@ AC_SUBST(LIB_PREFIX)
 AC_SUBST(LIB_SUFFIX)
 
 dnl Check for gtk-sharp
-PKG_CHECK_MODULES(GLIB_SHARP, glib-sharp-3.0 >= 2.99.2)
+PKG_CHECK_MODULES(GLIB_SHARP, glib-sharp-3.0 >= 2.99.3)
 AC_SUBST(GLIB_SHARP_CFLAGS)
 AC_SUBST(GLIB_SHARP_LIBS)
 gtksharp_prefix=`pkg-config --variable=prefix gtk-sharp-3.0`
 AC_SUBST(gtksharp_prefix)
 
 dnl Find GAPI
-PKG_CHECK_MODULES(GAPI, gapi-3.0 >= 2.99.2)
+PKG_CHECK_MODULES(GAPI, gapi-3.0 >= 2.99.3)
 
 dnl Check for gapi
 AC_PATH_PROG(GAPI_PARSER, gapi3-parser, no)
diff --git a/gstreamer-sharp.csproj b/gstreamer-sharp.csproj
index 7c9ebd7..89c3d50 100644
--- a/gstreamer-sharp.csproj
+++ b/gstreamer-sharp.csproj
@@ -40,7 +40,7 @@
   </ItemGroup>
   <ItemGroup>
     <Compile Include="sources\custom\*.cs" />
-    <Compile Include="sources\generated\*.cs" />
+    <Compile Include="sources\generated\**\*.cs" />
     <Compile Include="sources\AssemblyInfo.cs" />
   </ItemGroup>
   <Import Project="$(MSBuildBinPath)\Microsoft.CSharp.targets" />
diff --git a/sources/Makefile.am b/sources/Makefile.am
index 75d569c..8b2ef71 100644
--- a/sources/Makefile.am
+++ b/sources/Makefile.am
@@ -9,7 +9,7 @@ sources = custom/*.cs
 
 build_sources = AssemblyInfo.cs $(sources)
 
-CLEANFILES = $(DLL) generated-stamp generated/*.cs $(API)
+CLEANFILES = $(DLL) generated-stamp generated/*/*.cs $(API)
 
 DISTCLEANFILES = AssemblyInfo.cs $(DLLMAP)
 
@@ -30,7 +30,8 @@ $(API): $(srcdir)/$(RAW_API) $(srcdir)/$(METADATA)
 	$(GAPI_FIXUP) --api=$(srcdir)/$(API) --metadata=$(srcdir)/$(METADATA)
 
 generated-stamp: $(API)
-	 $(GAPI_CODEGEN) --generate $(srcdir)/$(API) $(GLIB_SHARP_CFLAGS) \
+	rm -rf generated/* && \
+	$(GAPI_CODEGEN) --generate $(srcdir)/$(API) $(GLIB_SHARP_CFLAGS) \
 		--outdir=generated \
 		--glue-filename=$(GLUEDIR)/generated.c --gluelib-name=libgstreamersharpglue-1.0.0.dll \
 		--glue-includes=gst/gst.h,`cd $(GST_INCLUDEDIR);find gst -type f | tr "\n" ","` \
@@ -38,7 +39,7 @@ generated-stamp: $(API)
 
 $(DLL): $(build_sources) generated-stamp
 	$(CSC) -nowarn:169 -unsafe -target:library $(GLIB_SHARP_LIBS) \
-		$(build_sources)  generated/*.cs -out:$(DLL)
+		$(build_sources)  generated/*/*.cs -out:$(DLL)
 
 install-data-local:
 	echo "$(GACUTIL) /i $(DLL) /f $(GACUTIL_FLAGS)";  \
@@ -47,3 +48,5 @@ install-data-local:
 uninstall-local:
 	echo "$(GACUTIL) /u $(ASSEMBLY_NAME) $(GACUTIL_FLAGS)"; \
         $(GACUTIL) /u $(ASSEMBLY_NAME) $(GACUTIL_FLAGS) || exit 1;
+clean-local:
+	-rm -r generated/*
diff --git a/sources/glue/Makefile.am b/sources/glue/Makefile.am
index cd669f5..6423a58 100644
--- a/sources/glue/Makefile.am
+++ b/sources/glue/Makefile.am
@@ -13,6 +13,6 @@ INCLUDES = $(GST_CFLAGS) -I$(top_srcdir)
 libgstreamersharpglue.dll: $(libgstreamersharpglue_1_0_0_la_OBJECTS) libgstreamersharpglue.rc libgstreamersharpglue.def
 	./build-dll libgstreamersharpglue $(VERSION)
 
-CLEANFILES = lib*.a lib*.dll
+CLEANFILES = lib*.a lib*.dll generated.c
 
 EXTRA_DIST =
diff --git a/sources/gstreamer-sharp.metadata b/sources/gstreamer-sharp.metadata
index 100790a..90b2eb1 100644
--- a/sources/gstreamer-sharp.metadata
+++ b/sources/gstreamer-sharp.metadata
@@ -208,32 +208,6 @@ along with this program.  If not, see <http://www.gnu.org/licenses/>.
 	<attr path="/api/namespace[@name='GstRtp']" name="name">Gst.Rtp</attr>
 	<attr path="/api/namespace[@name='GstRtsp']" name="name">Gst.Rtsp</attr>
 	<attr path="/api/namespace[@name='GstSdp']" name="name">Gst.Sdp</attr>
-	<attr path="/api/namespace[@name='Gst.Base']/object[@name='Global']" name="name">GlobalBase</attr>
-	<attr path="/api/namespace[@name='Gst.Video']/object[@name='Global']" name="name">GlobalVideo</attr>
-	<attr path="/api/namespace[@name='Gst.Audio']/object[@name='Global']" name="name">GlobalAudio</attr>
-	<attr path="/api/namespace[@name='Gst.PbUtils']/object[@name='Global']" name="name">GlobalPbUtil</attr>
-	<attr path="/api/namespace[@name='Gst.Tags']/object[@name='Global']" name="name">GlobalTag</attr>
-	<attr path="/api/namespace[@name='Gst.App']/object[@name='Global']" name="name">GlobalApp</attr>
-	<attr path="/api/namespace[@name='Gst.Controller']/object[@name='Global']" name="name">GlobalController</attr>
-	<attr path="/api/namespace[@name='Gst.FFT']/object[@name='Global']" name="name">GlobalFFT</attr>
-	<attr path="/api/namespace[@name='Gst.Net']/object[@name='Global']" name="name">GlobalNet</attr>
-	<attr path="/api/namespace[@name='Gst.Riff']/object[@name='Global']" name="name">GlobalRiff</attr>
-	<attr path="/api/namespace[@name='Gst.Rtp']/object[@name='Global']" name="name">GlobalRtp</attr>
-	<attr path="/api/namespace[@name='Gst.Rtsp']/object[@name='Global']" name="name">GlobalRtsp</attr>
-	<attr path="/api/namespace[@name='Gst.Sdp']/object[@name='Global']" name="name">GlobalSdp</attr>
-	<attr path="/api/namespace[@name='Gst.Base']/object[@name='Constants']" name="name">ConstantsBase</attr>
-	<attr path="/api/namespace[@name='Gst.Video']/object[@name='Constants']" name="name">ConstantsVideo</attr>
-	<attr path="/api/namespace[@name='Gst.Audio']/object[@name='Constants']" name="name">ConstantsAudio</attr>
-	<attr path="/api/namespace[@name='Gst.PbUtils']/object[@name='Constants']" name="name">ConstantsPbUtil</attr>
-	<attr path="/api/namespace[@name='Gst.Tags']/object[@name='Constants']" name="name">ConstantsTag</attr>
-	<attr path="/api/namespace[@name='Gst.App']/object[@name='Constants']" name="name">ConstantsApp</attr>
-	<attr path="/api/namespace[@name='Gst.Controller']/object[@name='Constants']" name="name">ConstantsController</attr>
-	<attr path="/api/namespace[@name='Gst.FFT']/object[@name='Constants']" name="name">ConstantsFFT</attr>
-	<attr path="/api/namespace[@name='Gst.Net']/object[@name='Constants']" name="name">ConstantsNet</attr>
-	<attr path="/api/namespace[@name='Gst.Riff']/object[@name='Constants']" name="name">ConstantsRiff</attr>
-	<attr path="/api/namespace[@name='Gst.Rtp']/object[@name='Constants']" name="name">ConstantsRtp</attr>
-	<attr path="/api/namespace[@name='Gst.Rtsp']/object[@name='Constants']" name="name">ConstantsRtsp</attr>
-	<attr path="/api/namespace[@name='Gst.Sdp']/object[@name='Constants']" name="name">ConstantsSdp</attr>
 
 	<!-- FIXME: Remove when https://bugzilla.gnome.org/show_bug.cgi?id=710001 is fixed -->
 	<attr path="/api/namespace" name="library">libgstreamer-1.0-0.dll</attr>
-- 
2.1.4

